services:
  # Registry Service (Eureka Server)
#  registry-service:
#    build:
#      context: ./microservices/registry-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-registry
#    restart: unless-stopped
#    ports:
#      - "8761:8761"
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#    networks:
#      - neo4flix-network

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: neo4flix-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - neo4flix-network

  # Neo4j Database
  neo4j:
    image: neo4j:latest
    container_name: neo4flix-neo4j
    restart: unless-stopped
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j_data:/data
      - neo4j_logs:/logs
      - neo4j_import:/var/lib/neo4j/import
      - neo4j_plugins:/plugins
    environment:
      - NEO4J_AUTH=neo4j/password
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*,gds.*
      - NEO4J_dbms_security_procedures_allowlist=apoc.*,gds.*
      - NEO4J_dbms_connector_https_advertised__address=localhost:7473
      - NEO4J_dbms_connector_http_advertised__address=localhost:7474
      - NEO4J_dbms_connector_bolt_advertised__address=localhost:7687
    networks:
      - neo4flix-network

  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: neo4flix-zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - neo4flix-network
    volumes:
      - zookeeper-data:/var/lib/zookeeper/data
      - zookeeper-logs:/var/lib/zookeeper/log

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: neo4flix-kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
      - "29092:29092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_HOST://localhost:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'
      KAFKA_LOG_RETENTION_HOURS: 168
      KAFKA_LOG_RETENTION_BYTES: 1073741824
    networks:
      - neo4flix-network
    volumes:
      - kafka-data:/var/lib/kafka/data
    healthcheck:
      test: [ "CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092" ]
      interval: 10s
      timeout: 10s
      retries: 5

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: neo4flix-kafka-ui
    depends_on:
      - kafka
    ports:
      - "9091:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: neo4flix-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
      DYNAMIC_CONFIG_ENABLED: 'true'
    networks:
      - neo4flix-network

  # MinIO Object Storage
  minio:
    image: minio/minio:latest
    container_name: neo4flix-minio
    restart: unless-stopped
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin123
    command: server /data --console-address ":9001"
    volumes:
      - minio_data:/data
    networks:
      - neo4flix-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3


#  # Movie Microservice
#  movie-service:
#    build:
#      context: ./microservices/movie-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-movie-service
#    restart: unless-stopped
#    ports:
#      - "9081:9081"
#    depends_on:
#      - neo4j
#      - kafka
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - NEO4J_URI=bolt://neo4j:7687
#      - NEO4J_USERNAME=neo4j
#      - NEO4J_PASSWORD=password
#      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
#      - JWT_SECRET=mySecretKeyForJWTTokenGeneration2024
#    networks:
#      - neo4flix-network
#
#  # User Microservice
#  user-service:
#    build:
#      context: ./microservices/user-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-user-service
#    restart: unless-stopped
#    ports:
#      - "9084:9084"
#    depends_on:
#      - neo4j
#      - kafka
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - NEO4J_URI=bolt://neo4j:7687
#      - NEO4J_USERNAME=neo4j
#      - NEO4J_PASSWORD=password
#      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
#      - JWT_SECRET=mySecretKeyForJWTTokenGeneration2024
#    networks:
#      - neo4flix-network
#
#  # Rating Microservice
#  rating-service:
#    build:
#      context: ./microservices/rating-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-rating-service
#    restart: unless-stopped
#    ports:
#      - "9082:9082"
#    depends_on:
#      - neo4j
#      - kafka
#      - recommendation-service
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - NEO4J_URI=bolt://neo4j:7687
#      - NEO4J_USERNAME=neo4j
#      - NEO4J_PASSWORD=password
#      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
#      - JWT_SECRET=mySecretKeyForJWTTokenGeneration2024
#      - RECOMMENDATION_SERVICE_URL=http://recommendation-service:9083
#    networks:
#      - neo4flix-network
#
#  # Recommendation Microservice
#  recommendation-service:
#    build:
#      context: ./microservices/recommendation-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-recommendation-service
#    restart: unless-stopped
#    ports:
#      - "9083:9083"
#    depends_on:
#      - neo4j
#      - kafka
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - NEO4J_URI=bolt://neo4j:7687
#      - NEO4J_USERNAME=neo4j
#      - NEO4J_PASSWORD=password
#      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
#      - JWT_SECRET=mySecretKeyForJWTTokenGeneration2024
#    networks:
#      - neo4flix-network
#
#  # Watchlist Microservice
#  watchlist-service:
#    build:
#      context: ./microservices/watchlist-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-watchlist-service
#    restart: unless-stopped
#    ports:
#      - "9085:9085"
#    depends_on:
#      - neo4j
#      - kafka
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - NEO4J_URI=bolt://neo4j:7687
#      - NEO4J_USERNAME=neo4j
#      - NEO4J_PASSWORD=password
#      - KAFKA_BOOTSTRAP_SERVERS=kafka:9092
#      - JWT_SECRET=mySecretKeyForJWTTokenGeneration2024
#    networks:
#      - neo4flix-network
#
#  # Gateway Service (API Gateway)
#  gateway-service:
#    build:
#      context: ./microservices/gateway-service
#      dockerfile: Dockerfile
#    container_name: neo4flix-gateway
#    restart: unless-stopped
#    ports:
#      - "9080:9080"
#    depends_on:
#      - redis
#      - movie-service
#      - user-service
#      - rating-service
#      - recommendation-service
#      - watchlist-service
#    environment:
#      - SPRING_PROFILES_ACTIVE=docker
#      - REDIS_HOST=redis
#      - REDIS_PORT=6379
#      - MOVIE_SERVICE_URL=http://movie-service:9081
#      - USER_SERVICE_URL=http://user-service:9084
#      - RATING_SERVICE_URL=http://rating-service:9082
#      - RECOMMENDATION_SERVICE_URL=http://recommendation-service:9083
#      - WATCHLIST_SERVICE_URL=http://watchlist-service:9085
#      - JWT_SECRET=mySecretKeyForJWTTokenGeneration2024
#    networks:
#      - neo4flix-network
#
#  # Angular Frontend
#  frontend:
#    build:
#      context: ./frontend
#      dockerfile: Dockerfile
#    container_name: neo4flix-frontend
#    restart: unless-stopped
#    ports:
#      - "4200:80"
#    depends_on:
#      - gateway-service
#    environment:
#      - API_BASE_URL=http://localhost:8080
#    networks:
#      - neo4flix-network

volumes:
  neo4j_data:
  neo4j_logs:
  neo4j_import:
  neo4j_plugins:
  redis_data:
  kafka-data:
  zookeeper-data:
  zookeeper-logs:
  minio_data:

networks:
  neo4flix-network:
    driver: bridge